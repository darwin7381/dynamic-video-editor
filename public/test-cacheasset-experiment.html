<!DOCTYPE html>
<html>
<head>
  <title>cacheAsset å¯¦é©—</title>
  <script src="https://cdn.creatomate.com/libs/preview/1.6.0/preview.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #preview { width: 800px; height: 450px; background: #000; margin: 20px 0; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    button { padding: 10px 20px; margin: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>ğŸ§ª cacheAsset æ·±åº¦å¯¦é©—</h1>
  
  <div id="preview"></div>
  
  <h2>æ¸¬è©¦æ§åˆ¶</h2>
  <button onclick="test1()">æ¸¬è©¦ 1: Google å½±ç‰‡ï¼ˆç›´æ¥ä¸‹è¼‰ + cacheAssetï¼‰</button>
  <button onclick="test2()">æ¸¬è©¦ 2: 2050today å½±ç‰‡ï¼ˆä»£ç†ä¸‹è¼‰ + cacheAssetï¼‰</button>
  <button onclick="test3()">æ¸¬è©¦ 3: GIFï¼ˆç›´æ¥ä¸‹è¼‰ + å½è£ + cacheAssetï¼‰</button>
  <button onclick="test4()">æ¸¬è©¦ 4: GIF ä¸å½è£ï¼ˆç›´æ¥ä¸‹è¼‰ + cacheAssetï¼‰</button>
  
  <h2>æ—¥èªŒ</h2>
  <pre id="log"></pre>

  <script>
    const PUBLIC_TOKEN = 'public-s28tr0cxnbxb0gmlvzyzn2hu';
    let preview;
    let logs = [];
    
    function log(msg) {
      console.log(msg);
      logs.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
      document.getElementById('log').textContent = logs.join('\n');
    }
    
    // åˆå§‹åŒ–
    const previewContainer = document.getElementById('preview');
    preview = new Preview(previewContainer, 'player', PUBLIC_TOKEN);
    
    preview.onReady = () => {
      log('âœ… Preview SDK æº–å‚™å°±ç·’');
    };
    
    preview.onLoad = () => log('â³ é–‹å§‹è¼‰å…¥...');
    preview.onLoadComplete = () => log('âœ… è¼‰å…¥å®Œæˆ');
    
    // æ¸¬è©¦ 1: Google å½±ç‰‡ï¼ˆç›´æ¥ä¸‹è¼‰ï¼‰
    async function test1() {
      try {
        log('\n=== æ¸¬è©¦ 1: Google å½±ç‰‡ï¼ˆæœ‰ CORSï¼‰===');
        const url = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4';
        
        log('ä¸‹è¼‰ä¸­...');
        const response = await fetch(url);
        const blob = await response.blob();
        log(`ä¸‹è¼‰å®Œæˆ: ${blob.size} bytes, type: ${blob.type}`);
        
        log('å¿«å–ä¸­...');
        await preview.cacheAsset(url, blob);
        log('âœ… å¿«å–æˆåŠŸ');
        
        log('è¨­å®š source...');
        await preview.setSource({
          width: 1920,
          height: 1080,
          elements: [{
            type: 'video',
            source: url,
            duration: '5 s'
          }]
        });
        log('âœ… æ¸¬è©¦ 1 å®Œå…¨æˆåŠŸï¼');
        
      } catch (e) {
        log(`âŒ æ¸¬è©¦ 1 å¤±æ•—: ${e.message}`);
      }
    }
    
    // æ¸¬è©¦ 2: 2050today å½±ç‰‡ï¼ˆé€éä»£ç†ï¼‰
    async function test2() {
      try {
        log('\n=== æ¸¬è©¦ 2: 2050today å½±ç‰‡ï¼ˆç„¡ CORSï¼Œç”¨ä»£ç†ï¼‰===');
        const originalUrl = 'https://2050today.org/wp-content/uploads/2020/07/Video-Placeholder.mp4?_=6';
        const proxyUrl = `/api/media-proxy?url=${encodeURIComponent(originalUrl)}`;
        
        log('é€éä»£ç†ä¸‹è¼‰ä¸­...');
        const response = await fetch(proxyUrl);
        log(`ä»£ç†å›æ‡‰: ${response.status} ${response.statusText}`);
        log(`Content-Type: ${response.headers.get('content-type')}`);
        log(`Content-Length: ${response.headers.get('content-length')}`);
        
        const arrayBuffer = await response.arrayBuffer();
        const contentType = response.headers.get('content-type') || 'video/mp4';
        const blob = new Blob([arrayBuffer], { type: contentType });
        
        log(`Blob å‰µå»º: ${blob.size} bytes, type: ${blob.type}`);
        
        log('å¿«å–ä¸­...');
        await preview.cacheAsset(originalUrl, blob);
        log('âœ… å¿«å–æˆåŠŸ');
        
        log('è¨­å®š source...');
        await preview.setSource({
          width: 1920,
          height: 1080,
          elements: [{
            type: 'video',
            source: originalUrl,
            duration: '5 s'
          }]
        });
        log('âœ… æ¸¬è©¦ 2 å®Œå…¨æˆåŠŸï¼');
        
      } catch (e) {
        log(`âŒ æ¸¬è©¦ 2 å¤±æ•—: ${e.message}`);
        console.error('è©³ç´°éŒ¯èª¤:', e);
      }
    }
    
    // æ¸¬è©¦ 3: GIF å½è£æˆ MP4
    async function test3() {
      try {
        log('\n=== æ¸¬è©¦ 3: GIF å½è£æˆ MP4 ===');
        const gifUrl = 'https://media.tenor.com/EOhh4Dv9AdUAAAAM/point-at-you-point.gif';
        const fakeUrl = gifUrl.replace('.gif', '.mp4?gif=' + Date.now());
        
        log('ä¸‹è¼‰ GIF...');
        const response = await fetch(gifUrl);
        const gifBlob = await response.blob();
        log(`GIF ä¸‹è¼‰å®Œæˆ: ${gifBlob.size} bytes, type: ${gifBlob.type}`);
        
        // å½è£æˆ MP4
        const arrayBuffer = await gifBlob.arrayBuffer();
        const fakeBlob = new Blob([arrayBuffer], { type: 'video/mp4' });
        log(`å½è£ Blob: ${fakeBlob.size} bytes, type: ${fakeBlob.type}`);
        
        log(`ä½¿ç”¨å‡ URL å¿«å–: ${fakeUrl}`);
        await preview.cacheAsset(fakeUrl, fakeBlob);
        log('âœ… å¿«å–æˆåŠŸ');
        
        log('è¨­å®š sourceï¼ˆä½¿ç”¨å‡ URLï¼‰...');
        await preview.setSource({
          width: 1920,
          height: 1080,
          elements: [{
            type: 'video',
            source: fakeUrl,
            duration: '4 s'
          }]
        });
        log('âœ… æ¸¬è©¦ 3 å®Œå…¨æˆåŠŸï¼');
        
      } catch (e) {
        log(`âŒ æ¸¬è©¦ 3 å¤±æ•—: ${e.message}`);
        console.error('è©³ç´°éŒ¯èª¤:', e);
      }
    }
    
    // æ¸¬è©¦ 4: GIF ä¸å½è£ï¼ˆåŸå§‹ï¼‰
    async function test4() {
      try {
        log('\n=== æ¸¬è©¦ 4: GIF ä¸å½è£ï¼ˆåŸå§‹ typeï¼‰===');
        const gifUrl = 'https://media.tenor.com/EOhh4Dv9AdUAAAAM/point-at-you-point.gif';
        
        log('ä¸‹è¼‰ GIF...');
        const response = await fetch(gifUrl);
        const blob = await response.blob();
        log(`GIF ä¸‹è¼‰å®Œæˆ: ${blob.size} bytes, type: ${blob.type}`);
        
        log('å¿«å–ï¼ˆåŸå§‹ typeï¼‰...');
        await preview.cacheAsset(gifUrl, blob);
        log('âœ… å¿«å–æˆåŠŸ');
        
        log('è¨­å®š source...');
        await preview.setSource({
          width: 1920,
          height: 1080,
          elements: [{
            type: 'video',
            source: gifUrl,
            duration: '4 s'
          }]
        });
        log('âœ… æ¸¬è©¦ 4 å®Œå…¨æˆåŠŸï¼');
        
      } catch (e) {
        log(`âŒ æ¸¬è©¦ 4 å¤±æ•—: ${e.message}`);
        console.error('è©³ç´°éŒ¯èª¤:', e);
      }
    }
  </script>
</body>
</html>

